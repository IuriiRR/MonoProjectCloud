services:

  firestore:
    build:
      context: .
      dockerfile: Dockerfile.firestore
    working_dir: /workspace
    volumes:
      - .:/workspace
    ports:
      - "8080:8080"
      - "9099:9099"
      - "4000:4000"
      - "4500:4500"
    command: >
      sh -c "firebase emulators:start --only firestore,auth --project demo-monobank --import=./.emulator-data --export-on-exit"

  users_api:
    build:
      context: .
      dockerfile: Dockerfile.users_api
    environment:
      - FIRESTORE_EMULATOR_HOST=firestore:8080
      - FIRESTORE_PROJECT_ID=demo-monobank
      - FIREBASE_AUTH_EMULATOR_HOST=firestore:9099
      - INTERNAL_API_KEY=dev-internal-key
    depends_on:
      - firestore
    ports:
      - "8081:8081"

  accounts_api:
    build:
      context: .
      dockerfile: Dockerfile.accounts_api
    environment:
      - FIRESTORE_EMULATOR_HOST=firestore:8080
      - FIRESTORE_PROJECT_ID=demo-monobank
      - FIREBASE_AUTH_EMULATOR_HOST=firestore:9099
      - INTERNAL_API_KEY=dev-internal-key
    depends_on:
      - firestore
    ports:
      - "8082:8082"

  transactions_api:
    build:
      context: .
      dockerfile: Dockerfile.transactions_api
    environment:
      - FIRESTORE_EMULATOR_HOST=firestore:8080
      - FIRESTORE_PROJECT_ID=demo-monobank
      - FIREBASE_AUTH_EMULATOR_HOST=firestore:9099
      - INTERNAL_API_KEY=dev-internal-key
    depends_on:
      - firestore
    ports:
      - "8083:8083"

  sync_worker:
    build:
      context: .
      dockerfile: Dockerfile.sync_worker
    environment:
      - FIRESTORE_EMULATOR_HOST=firestore:8080
      - FIRESTORE_PROJECT_ID=demo-monobank
      - USERS_API_URL=http://users_api:8081
      - ACCOUNTS_API_URL=http://accounts_api:8082
      - SYNC_TRANSACTIONS_URL=http://sync_transactions:8085
      - INTERNAL_API_KEY=dev-internal-key
    depends_on:
      - firestore
      - users_api
      - accounts_api
      - sync_transactions
    ports:
      - "8084:8084"

  sync_transactions:
    build:
      context: .
      dockerfile: Dockerfile.sync_transactions
    environment:
      - FIRESTORE_EMULATOR_HOST=firestore:8080
      - FIRESTORE_PROJECT_ID=demo-monobank
      - ACCOUNTS_API_URL=http://accounts_api:8082
      - TRANSACTIONS_API_URL=http://transactions_api:8083
      - INTERNAL_API_KEY=dev-internal-key
    depends_on:
      - firestore
      - accounts_api
      - transactions_api
    ports:
      - "8085:8085"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    environment:
      - VITE_USERS_API_URL=http://localhost:8081
      - VITE_ACCOUNTS_API_URL=http://localhost:8082
      - VITE_TRANSACTIONS_API_URL=http://localhost:8083
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - users_api
      - accounts_api
      - transactions_api
      - firestore
